<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê²½ì°° ì¬ë‚œê´€ë¦¬ í†µí•©ì‹œìŠ¤í…œ (Live)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9;
            --blue: #3b82f6; --red: #ef4444; --yellow: #eab308; --green: #22c55e;
        }
        body { font-family: 'Pretendard', -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* ìƒë‹¨ í—¤ë” */
        header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; background: #1e293b; padding: 15px; border-radius: 15px; border: 1px solid #334155; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.1rem; color: var(--blue); }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls { display: flex; gap: 10px; margin-top: 5px; }
        select { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 0.95rem; }
        #refresh-btn { width: 50px; background: var(--blue); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        #refresh-btn:active { transform: scale(0.9); background: #2563eb; }
        .spin { animation: spin 1s linear infinite; }

        /* ê¸°ìƒ ë°ì´í„° ê·¸ë¦¬ë“œ */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #334155; text-align: center; position: relative; }
        .card i { font-size: 2rem; margin-bottom: 8px; opacity: 0.9; }
        .label { font-size: 0.85rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        .value { font-size: 1.5rem; font-weight: 800; display: block; }
        .status { font-size: 0.75rem; padding: 3px 8px; border-radius: 20px; background: rgba(255,255,255,0.1); display: inline-block; margin-top: 6px; }

        /* ìƒíƒœ ìƒ‰ìƒ í´ë˜ìŠ¤ */
        .safe { color: var(--green); border-color: var(--green); }
        .warn { color: var(--yellow); border-color: var(--yellow); }
        .danger { color: var(--red); border-color: var(--red); animation: pulse 1.5s infinite; }

        /* [NEW] ì‹œì„¤ë¬¼ í†µì œ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .section-title { font-size: 0.95rem; color: #94a3b8; margin-bottom: 10px; border-left: 3px solid #3b82f6; padding-left: 10px; font-weight: bold; }
        .infra-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .infra-item { background: #1e293b; padding: 12px; border-radius: 10px; display: flex; flex-direction: column; gap: 5px; border: 1px solid #334155; }
        .infra-name { font-size: 0.85rem; font-weight: bold; color: #cbd5e1; }
        .infra-status { font-size: 0.8rem; padding: 4px; border-radius: 4px; text-align: center; font-weight: bold; }
        
        .st-ok { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid #22c55e; }
        .st-warn { background: rgba(234, 179, 8, 0.15); color: #facc15; border: 1px solid #eab308; }
        .st-ban { background: rgba(239, 68, 68, 0.15); color: #fb7185; border: 1px solid #ef4444; animation: pulse 2s infinite; }

        /* [NEW] í•«ë¼ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .hotline-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .hotline-btn { background: #1e293b; color: white; border: 1px solid #334155; padding: 12px 0; border-radius: 10px; font-size: 0.75rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; transition: 0.2s; }
        .hotline-btn:active { background: #334155; transform: scale(0.95); }
        .hotline-btn i { font-size: 1.4rem; }
        .btn-fire { color: #fb7185; } .btn-police { color: #38bdf8; } .btn-city { color: #facc15; } .btn-map { color: #4ade80; }

        /* ë¡œê·¸ì°½ */
        #log { height: 100px; overflow-y: auto; background: black; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; border: 1px solid #334155; }
        .log-item { margin-bottom: 4px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1><i class="fas fa-shield-alt"></i> ê²½ì°° ì¬ë‚œ í˜„ì¥ëŒ€ì‘</h1>
        <div id="gps-status" style="font-size:0.8rem; color:#94a3b8;"><i class="fas fa-satellite"></i> ì¤€ë¹„</div>
    </div>
    <div class="controls">
        <select id="location-select" onchange="manualLocation()">
            <option value="auto">ğŸ“¡ GPS ìë™ íƒìƒ‰</option>
            <option value="36.48,127.28" selected>ğŸ›ï¸ ì„¸ì¢…ì‹œì²­ (ê¸°ë³¸)</option>
            <option value="36.60,127.30">ğŸš” ì¡°ì¹˜ì›ì (ë¶ë¶€)</option>
            <option value="36.48,127.25">ğŸ™ï¸ ì–´ì§„ë™ (ì²­ì‚¬)</option>
            <option value="36.67,127.20">ğŸ”ï¸ ì „ì˜/ì†Œì • (ì‚°ê°„)</option>
        </select>
        <button id="refresh-btn" onclick="fetchData()"><i class="fas fa-sync-alt"></i></button>
    </div>
</header>

<div class="grid">
    <div class="card" id="card-rain">
        <i class="fas fa-cloud-rain" style="color:#38bdf8"></i>
        <span class="label">ì‹œê°„ë‹¹ ê°•ìˆ˜ëŸ‰</span>
        <span class="value" id="val-rain">-</span>
        <span class="status" id="st-rain">ëŒ€ê¸°ì¤‘</span>
    </div>
    <div class="card" id="card-snow">
        <i class="fas fa-snowflake" style="color:#f1f5f9"></i>
        <span class="label">ì‹ ì ì„¤</span>
        <span class="value" id="val-snow">-</span>
        <span class="status" id="st-snow">ëŒ€ê¸°ì¤‘</span>
    </div>
    <div class="card" id="card-temp">
        <i class="fas fa-temperature-high" style="color:#facc15"></i>
        <span class="label">ì‹¤ì‹œê°„ ê¸°ì˜¨</span>
        <span class="value" id="val-temp">-</span>
        <span class="status" id="st-temp">ëŒ€ê¸°ì¤‘</span>
    </div>
    <div class="card" id="card-fire">
        <i class="fas fa-fire" style="color:#fb7185"></i>
        <span class="label">ì‚°ë¶ˆìœ„í—˜ì§€ìˆ˜</span>
        <span class="value" id="val-fire">-</span>
        <span class="status" id="st-fire">ëŒ€ê¸°ì¤‘</span>
    </div>
</div>

<div class="section-title">ğŸš¦ ì£¼ìš” ì§€í•˜ì°¨ë„ ë° í•˜ì²œ í†µì œ</div>
<div class="infra-list">
    <div class="infra-item">
        <span class="infra-name">ì¡°ì¹˜ì› ì§€í•˜ì°¨ë„</span>
        <span class="infra-status st-ok" id="infra-1">ì •ìƒí†µí–‰</span>
    </div>
    <div class="infra-item">
        <span class="infra-name">ê¸ˆê°• ë³´í–‰êµ</span>
        <span class="infra-status st-ok" id="infra-2">ì •ìƒí†µí–‰</span>
    </div>
    <div class="infra-item">
        <span class="infra-name">ë¯¸í˜¸ê°• ë‘”ì¹˜</span>
        <span class="infra-status st-ok" id="infra-3">ì •ìƒí†µí–‰</span>
    </div>
    <div class="infra-item">
        <span class="infra-name">ì„¸ì¢… ì§€í•˜ì°¨ë„</span>
        <span class="infra-status st-ok" id="infra-4">ì •ìƒí†µí–‰</span>
    </div>
</div>

<div class="section-title">ğŸ“ ê¸´ê¸‰ í•«ë¼ì¸ & ì§€ì›</div>
<div class="hotline-grid">
    <button class="hotline-btn" onclick="location.href='tel:119'">
        <i class="fas fa-fire-extinguisher btn-fire"></i> ì†Œë°© 119
    </button>
    <button class="hotline-btn" onclick="location.href='tel:112'">
        <i class="fas fa-user-shield btn-police"></i> ìƒí™©ì‹¤ 112
    </button>
    <button class="hotline-btn" onclick="location.href='tel:044-120'">
        <i class="fas fa-building btn-city"></i> ì‹œì²­ ì¬ë‚œ
    </button>
    <button class="hotline-btn" onclick="window.open('https://m.map.kakao.com/actions/searchView?q=ëŒ€í”¼ì†Œ')">
        <i class="fas fa-map-location-dot btn-map"></i> ëŒ€í”¼ì†Œ ì°¾ê¸°
    </button>
</div>

<div id="log">
    <div class="log-item" style="color:#22c55e">[SYSTEM] ì¬ë‚œëŒ€ì‘ ì‹œìŠ¤í…œ ê°€ë™</div>
</div>

<script>
    // PWA ë“±ë¡
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }

    let currentLat = 36.48; // ì„¸ì¢…ì‹œì²­
    let currentLon = 127.28;

    window.onload = () => {
        fetchData(); // ì´ˆê¸° ë¡œë“œ
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('location-select').value = "auto";
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    document.getElementById('gps-status').innerHTML = "<span style='color:#22c55e'>ğŸ“¡ GPS ìˆ˜ì‹ ì¤‘</span>";
                    addLog("GPS ìœ„ì¹˜ë¡œ ê°±ì‹ í•©ë‹ˆë‹¤.");
                    fetchData();
                },
                (err) => {
                    document.getElementById('gps-status').innerHTML = "<span style='color:#ef4444'>ğŸ›°ï¸ ìˆ˜ë™ ëª¨ë“œ</span>";
                }, {timeout: 3000}
            );
        }
    };

    function manualLocation() {
        const sel = document.getElementById('location-select').value;
        if(sel === 'auto') return;
        const [lat, lon] = sel.split(',');
        currentLat = parseFloat(lat);
        currentLon = parseFloat(lon);
        addLog(`ì§€ì—­ ë³€ê²½: ${document.getElementById('location-select').selectedOptions[0].text}`);
        fetchData();
    }

    async function fetchData() {
        const btn = document.querySelector('#refresh-btn i');
        btn.classList.add('spin');
        
        try {
            // Open-Meteo API í˜¸ì¶œ
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&current=temperature_2m,relative_humidity_2m,rain,snowfall,wind_speed_10m&timezone=Asia%2FTokyo`;
            const res = await fetch(url);
            const data = await res.json();
            updateUI(data.current);
            addLog(`ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ (${data.current.temperature_2m}Â°C)`);
        } catch (e) {
            addLog("í†µì‹  ì˜¤ë¥˜! ì¸í„°ë„· í™•ì¸ í•„ìš”", true);
        } finally {
            setTimeout(() => btn.classList.remove('spin'), 500);
        }
    }

    function updateUI(data) {
        // 1. ê¸°ìƒ ë°ì´í„° ë°”ì¸ë”©
        const rain = data.rain;
        const snow = data.snowfall;
        const temp = data.temperature_2m;
        
        // ì‚°ë¶ˆì§€ìˆ˜ ê³„ì‚° (ìŠµë„+í’ì†)
        let fireIdx = (100 - data.relative_humidity_2m) + (data.wind_speed_10m * 1.5);
        if (temp > 25) fireIdx += 10;
        fireIdx = Math.min(Math.round(fireIdx), 100);

        // ì¹´ë“œ ì—…ë°ì´íŠ¸
        setCard('rain', `${rain}mm`, rain > 30 ? 'danger' : (rain > 10 ? 'warn' : 'safe'), rain > 30 ? 'í˜¸ìš°ê²½ë³´' : (rain > 0 ? 'ë¹„' : 'ë§‘ìŒ'));
        setCard('snow', `${snow}cm`, snow > 5 ? 'danger' : (snow > 1 ? 'warn' : 'safe'), snow > 5 ? 'ëŒ€ì„¤ê²½ë³´' : (snow > 0 ? 'ëˆˆ' : 'ì—†ìŒ'));
        setCard('temp', `${temp}Â°C`, (temp > 33 || temp < -10) ? 'danger' : ((temp < 0) ? 'warn' : 'safe'), (temp > 33 ? 'í­ì—¼' : (temp < -10 ? 'í•œíŒŒ' : 'ì ì •')));
        setCard('fire', fireIdx, fireIdx > 80 ? 'danger' : (fireIdx > 60 ? 'warn' : 'safe'), fireIdx > 80 ? 'ë§¤ìš°ìœ„í—˜' : (fireIdx > 60 ? 'ì£¼ì˜' : 'ë³´í†µ'));

        // 2. [í•µì‹¬] ê°•ìˆ˜ëŸ‰ì— ë”°ë¥¸ ì‹œì„¤ í†µì œ ìë™í™” ë¡œì§
        updateInfrastructure(rain, snow);
    }

    function updateInfrastructure(rain, snow) {
        const infra1 = document.getElementById('infra-1'); // ì¡°ì¹˜ì› ì§€í•˜ì°¨ë„
        const infra2 = document.getElementById('infra-2'); // ê¸ˆê°• ë³´í–‰êµ
        const infra3 = document.getElementById('infra-3'); // ë¯¸í˜¸ê°• ë‘”ì¹˜
        const infra4 = document.getElementById('infra-4'); // ì„¸ì¢… ì§€í•˜ì°¨ë„

        // ì´ˆê¸°í™”
        [infra1, infra2, infra3, infra4].forEach(el => {
            el.className = 'infra-status st-ok';
            el.innerText = 'ì •ìƒí†µí–‰';
        });

        // ë¡œì§: ë¹„ê°€ 30mm ì´ìƒì´ë©´ ì§€í•˜ì°¨ë„/ë‘”ì¹˜ í†µì œ
        if (rain >= 30) {
            setInfraStatus(infra3, 'st-ban', 'ì§„ì…í†µì œ');
            setInfraStatus(infra1, 'st-warn', 'ì¹¨ìˆ˜ì£¼ì˜');
            setInfraStatus(infra4, 'st-warn', 'ì¹¨ìˆ˜ì£¼ì˜');
            addLog("!! í˜¸ìš°ê²½ë³´: í•˜ìƒë„ë¡œ ë° ì§€í•˜ì°¨ë„ í†µì œ ìš”ë§", true);
        } else if (rain >= 10) {
            setInfraStatus(infra3, 'st-warn', 'ì ‘ê·¼ì£¼ì˜');
        }

        // ë¡œì§: ëˆˆì´ 5cm ì´ìƒì´ë©´ êµëŸ‰(ë³´í–‰êµ) í†µì œ ê³ ë ¤
        if (snow >= 5) {
            setInfraStatus(infra2, 'st-ban', 'ê²°ë¹™í†µì œ');
            addLog("!! ëŒ€ì„¤ê²½ë³´: êµëŸ‰ ë° ê³ ê°€ë„ë¡œ ê²°ë¹™ ì£¼ì˜", true);
        }
    }

    function setInfraStatus(element, statusClass, text) {
        element.className = `infra-status ${statusClass}`;
        element.innerText = text;
    }

    function setCard(id, val, level, text) {
        const elVal = document.getElementById(`val-${id}`);
        const elSt = document.getElementById(`st-${id}`);
        const card = document.getElementById(`card-${id}`);

        elVal.innerText = val;
        elSt.innerText = text;
        
        card.classList.remove('safe', 'warn', 'danger');
        elSt.className = 'status'; // reset style logic
        
        if (level === 'safe') { elSt.style.background = '#22c55e'; card.style.borderColor = '#22c55e'; }
        if (level === 'warn') { elSt.style.background = '#eab308'; card.style.borderColor = '#eab308'; elSt.style.color = 'black'; }
        if (level === 'danger') { elSt.style.background = '#ef4444'; card.style.borderColor = '#ef4444'; card.classList.add('danger'); }
    }

    function addLog(msg, isError = false) {
        const log = document.getElementById('log');
        const time = new Date().toLocaleTimeString('ko-KR', {hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
        const color = isError ? '#ef4444' : '#94a3b8';
        log.innerHTML = `<div class="log-item"><span style="color:#64748b">[${time}]</span> <span style="color:${color}">${msg}</span></div>` + log.innerHTML;
    }
</script>

</body>
</html>
