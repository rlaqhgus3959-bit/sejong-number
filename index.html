// 1. PWA 서비스 워커 등록 (앱 설치 기능)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('PWA 서비스 워커 등록 성공:', reg.scope))
            .catch(err => console.error('PWA 서비스 워커 등록 실패:', err));
    });
}

// 2. 페이지 로드 시 시스템 초기화
window.onload = function() {
    initSystem();
};

function initSystem() {
    const locationBar = document.getElementById('location-bar');
    
    // 시스템 가동 로그 출력
    updateLog('시스템', '경찰 재난관리 모니터링 엔진 가동 중...');
    
    if (navigator.geolocation) {
        // 위치 파악 시도 (5초 타임아웃 설정)
        navigator.geolocation.getCurrentPosition(successLocation, errorLocation, {
            enableHighAccuracy: true,
            timeout: 5000
        });
    } else {
        fallbackToDefault("지원하지 않는 브라우저");
    }
}

// 위치 정보 획득 성공 시
function successLocation(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    
    // 좌표 정보 표시 (세종시 중심 좌표 예시: 36.48, 127.28)
    const addr = `위도:${lat.toFixed(2)}, 경도:${lon.toFixed(2)} (현위치 확인됨)`;
    document.getElementById('location-bar').innerHTML = `<i class="fas fa-location-dot"></i> 설정 위치: <b>${addr}</b>`;
    
    // GPS 기반 알림 자동 호출
    showIntegratedAlerts("현위치(GPS)");
}

// 위치 정보 획득 실패 시 (권한 거부 등)
function errorLocation(error) {
    let msg = "";
    switch(error.code) {
        case error.PERMISSION_DENIED: msg = "위치 권한 거부됨"; break;
        case error.POSITION_UNAVAILABLE: msg = "위치 확인 불가"; break;
        case error.TIMEOUT: msg = "확인 시간 초과"; break;
        default: msg = "통신 오류"; break;
    }
    fallbackToDefault(msg);
}

// 기본값(세종시)으로 복구
function fallbackToDefault(reason) {
    const defaultAddr = "세종특별자치시 (기본 위치)";
    document.getElementById('location-bar').innerHTML = 
        `<i class="fas fa-circle-exclamation"></i> ${defaultAddr} - <small style="color:#ff4d4d">${reason}</small>`;
    
    showIntegratedAlerts("세종특별자치시");
}

// 현재 위치 기반 재난 데이터 로드 및 출력
function showIntegratedAlerts(location) {
    // 위치별 가상 데이터 (실제 운영 시 이 부분을 API fetch로 대체)
    const data = {
        "세종특별자치시": { rain: "5mm", snow: "0cm", fire: "72(높음)", heat: "33°C", msg: "금강 하상도로 침수 대비 순찰 강화" },
        "현위치(GPS)": { rain: "10mm", snow: "0cm", fire: "45(보통)", heat: "29°C", msg: "현재 위치 기반 기상 특보를 모니터링 중입니다." }
    };

    const currentData = data[location] || data["세종특별자치시"];

    // 상단 카드 수치 업데이트
    if(document.getElementById('rain-val')) document.getElementById('rain-val').innerText = currentData.rain;
    if(document.getElementById('snow-val')) document.getElementById('snow-val').innerText = currentData.snow;
    if(document.getElementById('fire-val')) document.getElementById('fire-val').innerText = currentData.fire;
    if(document.getElementById('heat-val')) document.getElementById('heat-val').innerText = currentData.heat;

    // 통합 알림 로그 순차 출력
    setTimeout(() => updateLog('데이터', `${location} 재난 정보 수신 성공`), 300);
    setTimeout(() => updateLog('현장대응', currentData.msg), 800);
    
    // 산불 위험이 높을 경우 경고 로그 추가
    if (parseInt(currentData.fire) > 70) {
        setTimeout(() => updateLog('경고', '산불 위험지수 [높음] - 입산 통제 및 화기 단속 강화'), 1300);
    }
}

// 로그 창에 메시지 추가 함수
function updateLog(type, message) {
    const logContent = document.getElementById('log-content');
    if (!logContent) return;

    const now = new Date();
    const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
    
    const newLog = document.createElement('div');
    newLog.className = 'log-entry';
    
    // 로그 유형별 색상 설정
    let typeColor = "white";
    if (type === '경고') typeColor = "#ff4d4d";
    if (type === '현장대응') typeColor = "#00d2ff";

    newLog.innerHTML = `<b style="color:yellow">[${timeStr}]</b> <span style="font-weight:bold; color:${typeColor}">[${type}]</span> ${message}`;
    logContent.prepend(newLog);
}
