<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê²½ì°° ì¬ë‚œê´€ë¦¬ ì‹œìŠ¤í…œ (Live)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9;
            --blue: #3b82f6; --red: #ef4444; --yellow: #eab308; --green: #22c55e;
        }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; background: #1e293b; padding: 15px; border-radius: 15px; border: 1px solid #334155; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.1rem; color: var(--blue); }
        
        /* ìœ„ì¹˜ ì„ íƒê¸° & ë²„íŠ¼ */
        .controls { display: flex; gap: 10px; margin-top: 5px; }
        select { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 0.95rem; }
        #refresh-btn { width: 50px; background: var(--blue); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        #refresh-btn:active { transform: scale(0.9); background: #2563eb; }
        .spin { animation: spin 1s linear infinite; }

        /* ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #334155; text-align: center; position: relative; }
        .card i { font-size: 2rem; margin-bottom: 8px; opacity: 0.9; }
        .label { font-size: 0.85rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        .value { font-size: 1.5rem; font-weight: 800; display: block; }
        .status { font-size: 0.75rem; padding: 3px 8px; border-radius: 20px; background: rgba(255,255,255,0.1); display: inline-block; margin-top: 6px; }

        /* ìœ„í—˜ë„ ìƒ‰ìƒ */
        .safe { color: var(--green); border-color: var(--green); }
        .warn { color: var(--yellow); border-color: var(--yellow); }
        .danger { color: var(--red); border-color: var(--red); animation: pulse 1.5s infinite; }

        /* ë¡œê·¸ì°½ */
        #log { margin-top: 20px; height: 120px; overflow-y: auto; background: black; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; border: 1px solid #334155; }
        .log-item { margin-bottom: 4px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1><i class="fas fa-shield-cat"></i> ì¬ë‚œ ëŒ€ì‘ í˜„í™©íŒ</h1>
        <div id="gps-status" style="font-size:0.8rem; color:#94a3b8;"><i class="fas fa-satellite"></i> ì¤€ë¹„</div>
    </div>
    <div class="controls">
        <select id="location-select" onchange="manualLocation()">
            <option value="auto">ğŸ“¡ GPS ìë™ íƒìƒ‰</option>
            <option value="36.48,127.28" selected>ğŸ›ï¸ ì„¸ì¢…ì‹œì²­ (ê¸°ë³¸)</option>
            <option value="36.60,127.30">ğŸš” ì¡°ì¹˜ì›ì (ë¶ë¶€)</option>
            <option value="36.48,127.25">ğŸ™ï¸ ì–´ì§„ë™ (ì²­ì‚¬)</option>
            <option value="36.67,127.20">ğŸ”ï¸ ì „ì˜/ì†Œì • (ì‚°ê°„)</option>
            <option value="36.41,127.28">ğŸ˜ï¸ ê¸ˆë‚¨ë©´ (ë‚¨ë¶€)</option>
        </select>
        <button id="refresh-btn" onclick="fetchData()"><i class="fas fa-sync-alt"></i></button>
    </div>
</header>

<div class="grid">
    <div class="card" id="card-rain">
        <i class="fas fa-cloud-rain" style="color:#38bdf8"></i>
        <span class="label">ì‹œê°„ë‹¹ ê°•ìˆ˜ëŸ‰</span>
        <span class="value" id="val-rain">-</span>
        <span class="status" id="st-rain">ëŒ€ê¸°ì¤‘</span>
    </div>
    <div class="card" id="card-snow">
        <i class="fas fa-snowflake" style="color:#f1f5f9"></i>
        <span class="label">ì‹ ì ì„¤</span>
        <span class="value" id="val-snow">-</span>
        <span class="status" id="st-snow">ëŒ€ê¸°ì¤‘</span>
    </div>
    <div class="card" id="card-temp">
        <i class="fas fa-temperature-high" style="color:#facc15"></i>
        <span class="label">ì‹¤ì‹œê°„ ê¸°ì˜¨</span>
        <span class="value" id="val-temp">-</span>
        <span class="status" id="st-temp">ëŒ€ê¸°ì¤‘</span>
    </div>
    <div class="card" id="card-fire">
        <i class="fas fa-fire" style="color:#fb7185"></i>
        <span class="label">ì‚°ë¶ˆìœ„í—˜ì§€ìˆ˜</span>
        <span class="value" id="val-fire">-</span>
        <span class="status" id="st-fire">ëŒ€ê¸°ì¤‘</span>
    </div>
</div>

<div id="log">
    <div class="log-item" style="color:#22c55e">[SYSTEM] ì‹œìŠ¤í…œ ë¶€íŒ… ì™„ë£Œ</div>
</div>

<script>
    // ê¸°ë³¸ ì¢Œí‘œ (ì„¸ì¢…ì‹œì²­)
    let currentLat = 36.48;
    let currentLon = 127.28;

    window.onload = () => {
        // ì‹œì‘í•˜ìë§ˆì ë°ì´í„° ë¡œë“œ
        fetchData();
        
        // GPS ì‹œë„
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const sel = document.getElementById('location-select');
                    sel.value = "auto";
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    document.getElementById('gps-status').innerHTML = "<span style='color:#22c55e'>ğŸ“¡ GPS ìˆ˜ì‹ ì¤‘</span>";
                    addLog("GPS ì‹ í˜¸ í¬ì°©: í˜„ì¬ ìœ„ì¹˜ë¡œ ê°±ì‹ í•©ë‹ˆë‹¤.");
                    fetchData();
                },
                (err) => {
                    document.getElementById('gps-status').innerHTML = "<span style='color:#ef4444'>ğŸ›°ï¸ GPS ì‹¤íŒ¨(ìˆ˜ë™)</span>";
                    addLog("GPS ìˆ˜ì‹  ì‹¤íŒ¨. ê¸°ë³¸ ì„¤ì •(ì„¸ì¢…ì‹œì²­)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.");
                },
                { timeout: 3000 }
            );
        }
    };

    function manualLocation() {
        const sel = document.getElementById('location-select').value;
        if(sel === 'auto') return; // GPS ëŒ€ê¸°
        
        const [lat, lon] = sel.split(',');
        currentLat = parseFloat(lat);
        currentLon = parseFloat(lon);
        addLog(`ìœ„ì¹˜ ë³€ê²½: ${document.getElementById('location-select').selectedOptions[0].text}`);
        fetchData();
    }

    async function fetchData() {
        const btn = document.querySelector('#refresh-btn i');
        btn.classList.add('spin'); // íšŒì „ ì‹œì‘

        addLog("ê¸°ìƒ ìœ„ì„± ë°ì´í„° ìˆ˜ì‹  ì‹œë„...");
        
        try {
            // Open-Meteo ì‹¤ì‹œê°„ API í˜¸ì¶œ
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&current=temperature_2m,relative_humidity_2m,rain,snowfall,wind_speed_10m&timezone=Asia%2FTokyo`;
            
            const res = await fetch(url);
            const data = await res.json();
            const now = data.current;

            updateUI(now);
            addLog(`ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ (ê¸°ì˜¨: ${now.temperature_2m}Â°C)`);
            
        } catch (e) {
            addLog("í†µì‹  ì˜¤ë¥˜ ë°œìƒ! ì¸í„°ë„· ì—°ê²° í™•ì¸ í•„ìš”.", true);
        } finally {
            setTimeout(() => btn.classList.remove('spin'), 500); // íšŒì „ ë©ˆì¶¤
        }
    }

    function updateUI(data) {
        // 1. ê°•ìˆ˜ëŸ‰
        const rain = data.rain;
        setCard('rain', `${rain}mm`, rain > 30 ? 'danger' : (rain > 5 ? 'warn' : 'safe'), rain > 30 ? 'ê²½ë³´ ë°œë ¹' : (rain > 0 ? 'ë¹„ ì˜´' : 'ë§‘ìŒ'));

        // 2. ì ì„¤ëŸ‰
        const snow = data.snowfall;
        setCard('snow', `${snow}cm`, snow > 5 ? 'danger' : (snow > 1 ? 'warn' : 'safe'), snow > 5 ? 'ëŒ€ì„¤ ê²½ë³´' : (snow > 0 ? 'ëˆˆ ì˜´' : 'ì ì„¤ ì—†ìŒ'));

        // 3. ê¸°ì˜¨
        const temp = data.temperature_2m;
        let tStatus = 'safe';
        let tText = 'ì ì •';
        if (temp > 33) { tStatus = 'danger'; tText = 'í­ì—¼ ê²½ë³´'; }
        else if (temp < -10) { tStatus = 'danger'; tText = 'í•œíŒŒ ê²½ë³´'; }
        else if (temp < 0) { tStatus = 'warn'; tText = 'ë™ì ˆê¸°'; }
        setCard('temp', `${temp}Â°C`, tStatus, tText);

        // 4. ì‚°ë¶ˆì§€ìˆ˜ (ìŠµë„ + í’ì† ê³„ì‚°)
        // ìŠµë„(ì‘ì„ìˆ˜ë¡ ìœ„í—˜) + í’ì†(í´ìˆ˜ë¡ ìœ„í—˜)
        let fireIdx = (100 - data.relative_humidity_2m) + (data.wind_speed_10m * 1.5);
        if (temp > 25) fireIdx += 10;
        fireIdx = Math.min(Math.round(fireIdx), 100);

        setCard('fire', fireIdx, fireIdx > 80 ? 'danger' : (fireIdx > 60 ? 'warn' : 'safe'), fireIdx > 80 ? 'ì…ì‚° ê¸ˆì§€' : (fireIdx > 60 ? 'í™”ê¸° ì—„ê¸ˆ' : 'ë³´í†µ'));
    }

    function setCard(id, val, level, text) {
        const elVal = document.getElementById(`val-${id}`);
        const elSt = document.getElementById(`st-${id}`);
        const card = document.getElementById(`card-${id}`);

        elVal.innerText = val;
        elSt.innerText = text;
        
        // ìƒ‰ìƒ ì´ˆê¸°í™” ë° ì¬ì„¤ì •
        elSt.className = 'status'; // reset
        card.classList.remove('safe', 'warn', 'danger');
        
        if (level === 'safe') { elSt.style.background = '#22c55e'; card.style.borderColor = '#22c55e'; }
        if (level === 'warn') { elSt.style.background = '#eab308'; card.style.borderColor = '#eab308'; elSt.style.color = 'black'; }
        if (level === 'danger') { elSt.style.background = '#ef4444'; card.style.borderColor = '#ef4444'; card.classList.add('danger'); }
    }

    function addLog(msg, isError = false) {
        const log = document.getElementById('log');
        const time = new Date().toLocaleTimeString('ko-KR', {hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
        const color = isError ? '#ef4444' : '#94a3b8';
        log.innerHTML = `<div class="log-item"><span style="color:#64748b">[${time}]</span> <span style="color:${color}">${msg}</span></div>` + log.innerHTML;
    }
</script>

</body>
</html>
