<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Police OS</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* iOS Design System Variables */
        :root {
            --ios-bg: #000000;
            --ios-card: #1c1c1e;
            --ios-card-blur: rgba(28, 28, 30, 0.7);
            --ios-blue: #0a84ff;
            --ios-red: #ff453a;
            --ios-green: #30d158;
            --ios-yellow: #ffd60a;
            --ios-gray: #8e8e93;
            --ios-text: #ffffff;
            --ios-subtext: #aeaeb2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, sans-serif;
            background-color: var(--ios-bg);
            color: var(--ios-text);
            margin: 0;
            padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* Header (Large Title Style) */
        header {
            padding-top: 20px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            margin-left: -20px; margin-right: -20px; padding-left: 20px; padding-right: 20px; /* Full width blur */
            border-bottom: 0.5px solid #333;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding-bottom: 15px;
        }

        h1 {
            margin: 0;
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1.1;
        }

        .gps-badge {
            font-size: 13px;
            background: rgba(10, 132, 255, 0.15);
            color: var(--ios-blue);
            padding: 4px 10px;
            border-radius: 100px;
            font-weight: 600;
        }

        /* Location Picker (iOS Segmented Control Look) */
        .controls {
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
        }

        .select-wrapper {
            flex: 1;
            position: relative;
            background: #2c2c2e;
            border-radius: 12px;
        }

        select {
            width: 100%;
            padding: 12px 15px;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            appearance: none;
            outline: none;
            font-weight: 500;
        }
        
        .select-wrapper::after {
            content: '\f078';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--ios-gray);
            font-size: 12px;
            pointer-events: none;
        }

        #refresh-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #2c2c2e;
            color: var(--ios-blue);
            border: none;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Widget Grid */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--ios-card);
            padding: 20px;
            border-radius: 22px; /* iOS Squircleish */
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 110px;
        }

        .card i { font-size: 24px; margin-bottom: 5px; }
        .label { font-size: 13px; color: var(--ios-subtext); font-weight: 500; }
        .value { font-size: 26px; font-weight: 600; letter-spacing: -0.5px; margin-top: auto; }
        .status-dot {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
        }

        /* Status Colors */
        .safe i { color: var(--ios-blue); } .safe .status-dot { background: var(--ios-green); box-shadow: 0 0 8px var(--ios-green); }
        .warn i { color: var(--ios-yellow); } .warn .status-dot { background: var(--ios-yellow); box-shadow: 0 0 8px var(--ios-yellow); }
        .danger i { color: var(--ios-red); } .danger .status-dot { background: var(--ios-red); box-shadow: 0 0 8px var(--ios-red); }

        /* Infrastructure List (iOS Settings Style) */
        .section-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--ios-text);
            padding-left: 5px;
        }

        .ios-list {
            background: var(--ios-card);
            border-radius: 18px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .ios-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 0.5px solid #38383a;
            font-size: 16px;
        }

        .ios-item:last-child { border-bottom: none; }

        .ios-badge {
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
        }
        .st-ok { color: var(--ios-green); background: rgba(48, 209, 88, 0.15); }
        .st-warn { color: var(--ios-yellow); background: rgba(255, 214, 10, 0.15); }
        .st-ban { color: var(--ios-red); background: rgba(255, 69, 58, 0.15); }

        /* Control Center Buttons */
        .control-center {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .cc-btn {
            background: #2c2c2e;
            border-radius: 18px;
            aspect-ratio: 1/1; /* Square */
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
            transition: transform 0.2s;
        }
        .cc-btn:active { transform: scale(0.92); background: #3a3a3c; }
        .cc-icon-box {
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            color: white;
        }
        .cc-label { font-size: 11px; font-weight: 500; }

        .btn-fire .cc-icon-box { background: var(--ios-red); }
        .btn-police .cc-icon-box { background: var(--ios-blue); }
        .btn-city .cc-icon-box { background: var(--ios-gray); }
        .btn-map .cc-icon-box { background: var(--ios-green); }

        /* Console/Log (Hidden by default, expandable maybe? Keeping simple for now) */
        #log-area {
            font-family: "SF Mono", monospace;
            font-size: 10px;
            color: #666;
            text-align: center;
            margin-top: 30px;
            opacity: 0.6;
        }

        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Home Indicator Space */
        .home-indicator-spacer { height: 20px; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1>ì¬ë‚œëŒ€ì‘<br>í˜„í™©íŒ</h1>
        <div id="gps-status" class="gps-badge">GPS ëŒ€ê¸°</div>
    </div>
</header>

<div class="controls">
    <div class="select-wrapper">
        <select id="location-select" onchange="manualLocation()">
            <option value="auto">ğŸ“¡ í˜„ìœ„ì¹˜ ìë™ (GPS)</option>
            <option value="36.48,127.28" selected>ğŸ›ï¸ ì„¸ì¢…ì‹œì²­</option>
            <option value="36.60,127.30">ğŸš” ì¡°ì¹˜ì›ì</option>
            <option value="36.48,127.25">ğŸ™ï¸ ì–´ì§„ë™</option>
            <option value="36.67,127.20">ğŸ”ï¸ ì „ì˜ë©´</option>
        </select>
    </div>
    <button id="refresh-btn" onclick="fetchData()"><i class="fas fa-arrow-rotate-right"></i></button>
</div>

<div class="grid">
    <div class="card safe" id="card-rain">
        <div class="status-dot"></div>
        <i class="fas fa-cloud-rain"></i>
        <span class="value" id="val-rain">-</span>
        <span class="label">ê°•ìˆ˜ëŸ‰ (mm)</span>
    </div>
    <div class="card safe" id="card-snow">
        <div class="status-dot"></div>
        <i class="fas fa-snowflake"></i>
        <span class="value" id="val-snow">-</span>
        <span class="label">ì ì„¤ëŸ‰ (cm)</span>
    </div>
    <div class="card warn" id="card-temp">
        <div class="status-dot"></div>
        <i class="fas fa-temperature-half"></i>
        <span class="value" id="val-temp">-</span>
        <span class="label">í˜„ì¬ ê¸°ì˜¨</span>
    </div>
    <div class="card danger" id="card-fire">
        <div class="status-dot"></div>
        <i class="fas fa-fire"></i>
        <span class="value" id="val-fire">-</span>
        <span class="label">ì‚°ë¶ˆì§€ìˆ˜</span>
    </div>
</div>

<div class="section-header">í†µì œ í˜„í™©</div>
<div class="ios-list">
    <div class="ios-item">
        <span>ì¡°ì¹˜ì› ì§€í•˜ì°¨ë„</span>
        <span class="ios-badge st-ok" id="infra-1">ì •ìƒ</span>
    </div>
    <div class="ios-item">
        <span>ê¸ˆê°• ë³´í–‰êµ</span>
        <span class="ios-badge st-ok" id="infra-2">ì •ìƒ</span>
    </div>
    <div class="ios-item">
        <span>ë¯¸í˜¸ê°• ë‘”ì¹˜</span>
        <span class="ios-badge st-ok" id="infra-3">ì •ìƒ</span>
    </div>
    <div class="ios-item">
        <span>ì„¸ì¢… ì§€í•˜ì°¨ë„</span>
        <span class="ios-badge st-ok" id="infra-4">ì •ìƒ</span>
    </div>
</div>

<div class="section-header">ê¸´ê¸‰ ëŒ€ì‘</div>
<div class="control-center">
    <button class="cc-btn btn-fire" onclick="location.href='tel:119'">
        <div class="cc-icon-box"><i class="fas fa-fire-extinguisher"></i></div>
        <span class="cc-label">119</span>
    </button>
    <button class="cc-btn btn-police" onclick="location.href='tel:112'">
        <div class="cc-icon-box"><i class="fas fa-shield-halved"></i></div>
        <span class="cc-label">112</span>
    </button>
    <button class="cc-btn btn-city" onclick="location.href='tel:044-120'">
        <div class="cc-icon-box"><i class="fas fa-phone"></i></div>
        <span class="cc-label">ì‹œì²­</span>
    </button>
    <button class="cc-btn btn-map" onclick="window.open('https://m.map.kakao.com/actions/searchView?q=ëŒ€í”¼ì†Œ')">
        <div class="cc-icon-box"><i class="fas fa-person-shelter"></i></div>
        <span class="cc-label">ëŒ€í”¼ì†Œ</span>
    </button>
</div>

<div id="log-area">System Ready â€¢ v8.0 iOS Theme</div>
<div class="home-indicator-spacer"></div>

<script>
    // PWA Init
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }

    let currentLat = 36.48; 
    let currentLon = 127.28;

    window.onload = () => {
        fetchData();
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('location-select').value = "auto";
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    document.getElementById('gps-status').innerText = "GPS ìˆ˜ì‹ ë¨";
                    document.getElementById('gps-status').style.color = "#30d158";
                    document.getElementById('gps-status').style.background = "rgba(48, 209, 88, 0.15)";
                    fetchData();
                },
                (err) => {
                    document.getElementById('gps-status').innerText = "ìˆ˜ë™ ëª¨ë“œ";
                    document.getElementById('gps-status').style.color = "#8e8e93";
                }, {timeout: 3000}
            );
        }
    };

    function manualLocation() {
        const sel = document.getElementById('location-select').value;
        if(sel === 'auto') return;
        const [lat, lon] = sel.split(',');
        currentLat = parseFloat(lat);
        currentLon = parseFloat(lon);
        fetchData();
    }

    async function fetchData() {
        const btn = document.querySelector('#refresh-btn i');
        btn.classList.add('spin');
        
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&current=temperature_2m,relative_humidity_2m,rain,snowfall,wind_speed_10m&timezone=Asia%2FTokyo`;
            const res = await fetch(url);
            const data = await res.json();
            updateUI(data.current);
            
            const now = new Date();
            document.getElementById('log-area').innerText = `Updated: ${now.toLocaleTimeString()}`;
        } catch (e) {
            document.getElementById('log-area').innerText = "Update Failed";
        } finally {
            setTimeout(() => btn.classList.remove('spin'), 500);
        }
    }

    function updateUI(data) {
        const rain = data.rain;
        const snow = data.snowfall;
        const temp = data.temperature_2m;
        
        // ì‚°ë¶ˆì§€ìˆ˜ ê³„ì‚°
        let fireIdx = (100 - data.relative_humidity_2m) + (data.wind_speed_10m * 1.5);
        if (temp > 25) fireIdx += 10;
        fireIdx = Math.min(Math.round(fireIdx), 100);

        setCard('rain', rain, rain > 30 ? 'danger' : (rain > 10 ? 'warn' : 'safe'));
        setCard('snow', snow, snow > 5 ? 'danger' : (snow > 1 ? 'warn' : 'safe'));
        setCard('temp', temp + "Â°", (temp > 33 || temp < -10) ? 'danger' : ((temp < 0) ? 'warn' : 'safe'));
        setCard('fire', fireIdx, fireIdx > 80 ? 'danger' : (fireIdx > 60 ? 'warn' : 'safe'));

        // ì‹œì„¤ í†µì œ ë¡œì§
        updateInfra(rain, snow);
    }

    function setCard(id, val, status) {
        const card = document.getElementById(`card-${id}`);
        const valEl = document.getElementById(`val-${id}`);
        
        valEl.innerText = val;
        
        // Remove old classes
        card.classList.remove('safe', 'warn', 'danger');
        card.classList.add(status);
    }

    function updateInfra(rain, snow) {
        const els = ['infra-1', 'infra-2', 'infra-3', 'infra-4'].map(id => document.getElementById(id));
        
        // ì´ˆê¸°í™”
        els.forEach(el => { el.className = 'ios-badge st-ok'; el.innerText = 'ì •ìƒ'; });

        // ë¡œì§ ì ìš©
        if (rain >= 30) {
            setInfra(els[2], 'st-ban', 'ì§„ì…ê¸ˆì§€'); // ë¯¸í˜¸ê°•
            setInfra(els[0], 'st-warn', 'ì£¼ì˜'); // ì§€í•˜ì°¨ë„
            setInfra(els[3], 'st-warn', 'ì£¼ì˜');
        } else if (rain >= 10) {
            setInfra(els[2], 'st-warn', 'ì ‘ê·¼ì£¼ì˜');
        }

        if (snow >= 5) {
            setInfra(els[1], 'st-ban', 'í†µì œ'); // êµëŸ‰
        }
    }

    function setInfra(el, cls, txt) {
        el.className = `ios-badge ${cls}`;
        el.innerText = txt;
    }
</script>

</body>
</html>
